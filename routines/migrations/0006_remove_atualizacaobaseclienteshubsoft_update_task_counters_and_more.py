# Generated by Django 5.2.7 on 2025-10-19 02:16

import django.utils.timezone
import pgtrigger.compiler
import pgtrigger.migrations
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('routines', '0005_alter_atualizacaobaseclienteshubsoft_execute_after'),
    ]

    operations = [
        pgtrigger.migrations.RemoveTrigger(
            model_name='atualizacaobaseclienteshubsoft',
            name='update_task_counters',
        ),
        migrations.AlterField(
            model_name='atualizacaobaseclienteshubsoft',
            name='execute_after',
            field=models.DateTimeField(blank=True, default=django.utils.timezone.now, null=True, verbose_name='Executar Ap√≥s'),
        ),
        pgtrigger.migrations.AddTrigger(
            model_name='atualizacaobaseclienteshubsoft',
            trigger=pgtrigger.compiler.Trigger(name='update_task_counters', sql=pgtrigger.compiler.UpsertTriggerSql(func="\n            DECLARE\n                tarefa_uuid UUID;\n            BEGIN\n                -- Captura o ID da tarefa alterada\n                tarefa_uuid := COALESCE(NEW.id_tarefa, OLD.id_tarefa);\n\n                -- Atualiza os contadores na tabela routines_task\n                UPDATE routines_task AS t\n                SET\n                    total_rotinas = COALESCE(sub.total, 0),\n                    rotinas_pendentes = COALESCE(sub.pending, 0),\n                    rotinas_processando = COALESCE(sub.in_progress, 0),\n                    rotinas_erros = COALESCE(sub.failed, 0),\n                    rotinas_outros = COALESCE(sub.others, 0)\n                FROM (\n                    SELECT\n                        id_tarefa,\n                        COUNT(*) AS total,\n                        COUNT(*) FILTER (WHERE status = 'pending') AS pending,\n                        COUNT(*) FILTER (WHERE status = 'in_progress') AS in_progress,\n                        COUNT(*) FILTER (WHERE status = 'failed') AS failed,\n                        COUNT(*) FILTER (WHERE status NOT IN ('pending','in_progress','failed')) AS others\n                    FROM routines_atualizacaobaseclienteshubsoft\n                    GROUP BY id_tarefa\n                ) AS sub\n                WHERE t.id = tarefa_uuid\n                  AND t.id = sub.id_tarefa;\n\n                RETURN NULL;\n            END;\n        ", hash='c37f0b13cf9c4707a69f46c145c736fc07c91ced', operation='INSERT OR UPDATE OR DELETE', pgid='pgtrigger_update_task_counters_9b851', table='routines_atualizacaobaseclienteshubsoft', when='AFTER')),
        ),
    ]
